@page "/EpisodeDetails/{id:int}"
@inject HttpClient Http
@using RickAndMortyAPI.Components.Data

<h2>Episode Details</h2>

@if (episode == null)
{
        <p>Loading episode...</p>
}
else
{
        <h3>@episode.name (@episode.episode)</h3>
        <p><strong>Air Date:</strong> @episode.air_date</p>

        <h4>Characters</h4>
    @if (characters == null)
    {
                <p>Loading characters...</p>
    }
    else
    {
                <div class="row">
            @foreach (var c in characters)
            {
                            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                                <div class="card h-100">
                                    <img class="card-img-top" src="@c.image" alt="@c.name" />
                                    <div class="card-body">
                                        <h5 class="card-title">@c.name</h5>
                                        <NavLink class="btn btn-primary btn-sm" href="@($"/CharacterDetails/{c.id}")">
                                            View Character
                                        </NavLink>
                                    </div>
                                </div>
                            </div>
            }
                </div>
    }
}

@code {
    [Parameter] public int id { get; set; }

    Episode? episode;
    List<Character>? characters;

    protected override async Task OnInitializedAsync()
    {
        episode = await Http.GetFromJsonAsync<Episode>($"https://rickandmortyapi.com/api/episode/{id}");

        if (episode != null && episode.characters.Any())
        {
            var ids = episode.characters.Select(url => url.Split('/').Last()).ToList();
            var idsCsv = string.Join(",", ids);
            characters = await Http.GetFromJsonAsync<List<Character>>($"https://rickandmortyapi.com/api/character/{idsCsv}");
        }
    }

    public class Character
    {
        public int id { get; set; }
        public string name { get; set; } = string.Empty;
        public string image { get; set; } = string.Empty;
    }
}
